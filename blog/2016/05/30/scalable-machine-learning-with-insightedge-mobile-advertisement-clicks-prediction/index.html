
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Scalable machine learning with InsightEdge: mobile advertisement clicks prediction - Shady Minds</title>
  <meta name="author" content="Oleksiy Dyagilev">

  
  <meta name="description" content="This blog post will provide an introduction into using machine learning algorithms with InsightEdge. We will go through an exercise to predict mobile &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dyagilev.org/blog/2016/05/30/scalable-machine-learning-with-insightedge-mobile-advertisement-clicks-prediction">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Shady Minds" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30316607-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Shady Minds</a></h1>
  
    <h2>Oleksiy Dyagilev on computer science and related ..</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dyagilev.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Scalable machine learning with InsightEdge: mobile advertisement clicks prediction</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-05-30T20:34:42+03:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:34 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This blog post will provide an introduction into using machine learning algorithms with <a href="http://insightedge.io/">InsightEdge</a>. We will go through an exercise to predict mobile advertisement click-through rate with <a href="https://www.kaggle.com/c/avazu-ctr-prediction">Avazu’s dataset</a>.</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
  <li><a href="#loading-the-data" id="markdown-toc-loading-the-data">Loading the data</a></li>
  <li><a href="#exploring-the-data" id="markdown-toc-exploring-the-data">Exploring the data</a></li>
  <li><a href="#processing-and-transforming-the-data" id="markdown-toc-processing-and-transforming-the-data">Processing and transforming the data</a></li>
  <li><a href="#saving-preprocessed-data-to-the-data-grid" id="markdown-toc-saving-preprocessed-data-to-the-data-grid">Saving preprocessed data to the data grid</a></li>
  <li><a href="#a-simple-algorithm" id="markdown-toc-a-simple-algorithm">A simple algorithm</a></li>
  <li><a href="#experimenting-with-more-features" id="markdown-toc-experimenting-with-more-features">Experimenting with more features</a></li>
  <li><a href="#tuning-algorithm-parameters" id="markdown-toc-tuning-algorithm-parameters">Tuning algorithm parameters</a></li>
  <li><a href="#architecture" id="markdown-toc-architecture">Architecture</a></li>
  <li><a href="#summary" id="markdown-toc-summary">Summary</a></li>
</ul>

<h2 id="overview">Overview</h2>

<p>There are several compensation models in online advertising industry, probably the most notable is CPC (Cost Per Click), in which an advertiser pays a publisher when the ad is clicked.
Search engine advertising is one of the most popular forms of CPC. It allows advertisers to bid for ad placement in a search engine’s sponsored links when someone searches on a keyword that is related to their business offering.</p>

<p>For the search engines like Google, advertising is one of the main sources of their revenue. The challenge for the advertising system is to determine what ad should be displayed for each query that the search engine receives.</p>

<p>The revenue search engine can get is essentially:</p>

<p><code>revenue = bid * probability_of_click</code></p>

<p>The goal is to maximize the revenue for every search engine query. Whereis the <code>bid</code> is a known value, the <code>probability_of_click</code> is not. Thus predicting the probability of click becomes the key task.</p>

<p>Working on a machine learning problem involves a lot of experiments with feature selection, feature transformation, training different models and tuning parameters.While there are a few excellent machine learning libraries for Python and R, like scikit-learn, their capabilities are typically limited to relatively small datasets that you fit on a single machine.</p>

<p>With the large datasets and/or CPU intensive workloads you may want to scale out beyond a single machine. This is one of the key benefits of InsightEdge, since it’s able to scale the computation and data storage layers across many machines under one unified cluster.</p>

<h2 id="loading-the-data">Loading the data</h2>

<p>The <a href="https://www.kaggle.com/c/avazu-ctr-prediction/data">dataset</a> consists of:</p>

<ul>
  <li>train (5.9G) - Training set. 10 days of click-through data, ordered chronologically. Non-clicks and clicks are subsampled according to different strategies.</li>
  <li>test (674M) - Test set. 1 day of ads to test model predictions.</li>
</ul>

<p>At first, we want to launch InsightEdge.</p>

<p>To get the first data insights quickly, one can <a href="http://insightedge.io/docs/010/0_quick_start.html">launch InsightEdge on a laptop</a>.
Though for the big datasets or compute-intensive tasks the resources of a single machine might not be enough.</p>

<p>For this problem we will <a href="http://insightedge.io/docs/010/13_cluster_setup.html">setup a cluster</a> with four workers and place the downloaded files on HDFS.</p>

<p><img src="/images/ie-ml/0_cluster.png" /></p>

<p>Let’s open the interactive <a href="http://insightedge.io/docs/010/14_notebook.html">Web Notebook</a> and start exploring our dataset.</p>

<p>The dataset is in csv format, so we will use databricks csv library to load it from hdfs into the Spark dataframe:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="o">%</span><span class="n">dep</span>
</span><span class="line"><span class="n">z</span><span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;com.databricks:spark-csv_2.10:1.3.0&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Load the dataframe into Spark memory and cache:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span>
</span><span class="line">      <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;com.databricks.spark.csv&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;header&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;inferSchema&quot;</span><span class="o">,</span> <span class="s">&quot;false&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;hdfs://10.8.1.116/data/avazu_ctr/train&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="exploring-the-data">Exploring the data</h2>

<p>Now that we have the dataset in Spark memory, we can read the first rows:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="o">+--------------------+-----+--------+----+----------+--------+-----------+-------------+--------+----------+------------+---------+---------+------------+-----------+----------------+-----+---+---+----+---+---+------+---+</span>
</span><span class="line"><span class="o">|</span>                  <span class="n">id</span><span class="o">|</span><span class="n">click</span><span class="o">|</span>    <span class="n">hour</span><span class="o">|</span>  <span class="n">C1</span><span class="o">|</span><span class="n">banner_pos</span><span class="o">|</span> <span class="n">site_id</span><span class="o">|</span><span class="n">site_domain</span><span class="o">|</span><span class="n">site_category</span><span class="o">|</span>  <span class="n">app_id</span><span class="o">|</span><span class="n">app_domain</span><span class="o">|</span><span class="n">app_category</span><span class="o">|</span><span class="n">device_id</span><span class="o">|</span><span class="n">device_ip</span><span class="o">|</span><span class="n">device_model</span><span class="o">|</span><span class="n">device_type</span><span class="o">|</span><span class="n">device_conn_type</span><span class="o">|</span>  <span class="n">C14</span><span class="o">|</span><span class="n">C15</span><span class="o">|</span><span class="n">C16</span><span class="o">|</span> <span class="n">C17</span><span class="o">|</span><span class="n">C18</span><span class="o">|</span><span class="n">C19</span><span class="o">|</span>   <span class="n">C20</span><span class="o">|</span><span class="n">C21</span><span class="o">|</span>
</span><span class="line"><span class="o">+--------------------+-----+--------+----+----------+--------+-----------+-------------+--------+----------+------------+---------+---------+------------+-----------+----------------+-----+---+---+----+---+---+------+---+</span>
</span><span class="line"><span class="o">|</span> <span class="mi">1000009418151094273</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">ddd2926e</span><span class="o">|</span>    <span class="mi">44956</span><span class="n">a24</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">2</span><span class="o">|</span><span class="mi">15706</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000169349117863715</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="mi">96809</span><span class="n">ac8</span><span class="o">|</span>    <span class="mi">711</span><span class="n">ee120</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">15704</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span><span class="mi">100084</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000371904215119486</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">b3cf8def</span><span class="o">|</span>    <span class="mi">8</span><span class="n">a4875bd</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">15704</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span><span class="mi">100084</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000640724480838376</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">e8275b8f</span><span class="o">|</span>    <span class="mi">6332421</span><span class="n">a</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">15706</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span><span class="mi">100084</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000679056417042096</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">1</span><span class="o">|</span><span class="n">fe8cc448</span><span class="o">|</span>   <span class="mi">9166</span><span class="n">c161</span><span class="o">|</span>     <span class="mi">0569</span><span class="n">f928</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="mi">9644</span><span class="n">d0bf</span><span class="o">|</span>    <span class="mi">779</span><span class="n">d90c2</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">18993</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">2161</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span><span class="mi">157</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000720757801103869</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="n">d6137915</span><span class="o">|</span>   <span class="n">bb1ef334</span><span class="o">|</span>     <span class="n">f028772b</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="mi">05241</span><span class="n">af0</span><span class="o">|</span>    <span class="mi">8</span><span class="n">a4875bd</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">16920</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1899</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span><span class="mi">431</span><span class="o">|</span><span class="mi">100077</span><span class="o">|</span><span class="mi">117</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000724729988544911</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">8</span><span class="n">fda644b</span><span class="o">|</span>   <span class="mi">25</span><span class="n">d4cfcd</span><span class="o">|</span>     <span class="n">f028772b</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">b264c159</span><span class="o">|</span>    <span class="n">be6db1d7</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">20362</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">2333</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">39</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span><span class="mi">157</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000918755742328737</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">1</span><span class="o">|</span><span class="n">e151e245</span><span class="o">|</span>   <span class="mi">7</span><span class="n">e091613</span><span class="o">|</span>     <span class="n">f028772b</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">e6f67278</span><span class="o">|</span>    <span class="n">be74e6fe</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">20632</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">2374</span><span class="o">|</span>  <span class="mi">3</span><span class="o">|</span> <span class="mi">39</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span> <span class="mi">23</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000949271186029916</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="mi">37</span><span class="n">e8da74</span><span class="o">|</span>    <span class="mi">5</span><span class="n">db079b5</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">2</span><span class="o">|</span><span class="mi">15707</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10001264480619467364</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">14102100</span><span class="o">|</span><span class="mi">1002</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">84</span><span class="n">c7ba46</span><span class="o">|</span>   <span class="n">c4e18dd6</span><span class="o">|</span>     <span class="mi">50</span><span class="n">e219e0</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">c357dbff</span><span class="o">|</span> <span class="n">f1ac7184</span><span class="o">|</span>    <span class="mi">373</span><span class="n">ecbe6</span><span class="o">|</span>          <span class="mi">0</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">21689</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">2496</span><span class="o">|</span>  <span class="mi">3</span><span class="o">|</span><span class="mi">167</span><span class="o">|</span><span class="mi">100191</span><span class="o">|</span> <span class="mi">23</span><span class="o">|</span>
</span><span class="line"><span class="o">+--------------------+-----+--------+----+----------+--------+-----------+-------------+--------+----------+------------+---------+---------+------------+-----------+----------------+-----+---+---+----+---+---+------+---+</span>
</span><span class="line"><span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">10</span> <span class="n">rows</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The data fields are:</p>

<ul>
  <li>id: ad identifier</li>
  <li>click: 0/1 for non-click/click</li>
  <li>hour: format is YYMMDDHH</li>
  <li>C1: anonymized categorical variable</li>
  <li>banner_pos</li>
  <li>site_id</li>
  <li>site_domain</li>
  <li>site_category</li>
  <li>app_id</li>
  <li>app_domain</li>
  <li>app_category</li>
  <li>device_id</li>
  <li>device_ip</li>
  <li>device_model</li>
  <li>device_type</li>
  <li>device_conn_type</li>
  <li>C14-C21 – anonymized categorical variables</li>
</ul>

<p>Let’s see how many rows are in the training dataset:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">totalCount</span> <span class="k">=</span> <span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="o">()</span>
</span><span class="line">
</span><span class="line"><span class="n">totalCount</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">40428967</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>There are about 40M+ rows in the dataset.</p>

<p>Let’s now calculate the CTR (click-through rate) of the dataset. The click-through rate is the number of times a click is made on the advertisement divided by the total impressions (the number of times an advertisement was served):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">clicks</span> <span class="k">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">&quot;click = 1&quot;</span><span class="o">).</span><span class="n">count</span><span class="o">()</span>
</span><span class="line"><span class="k">val</span> <span class="n">ctr</span> <span class="k">=</span> <span class="n">clicks</span><span class="o">.</span><span class="n">toFloat</span> <span class="o">/</span> <span class="n">totalCount</span>
</span><span class="line">
</span><span class="line"><span class="n">clicks</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">6865066</span>
</span><span class="line"><span class="n">ctr</span><span class="k">:</span> <span class="kt">Float</span> <span class="o">=</span> <span class="mf">0.16980562</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The CTR is 0.169 (or 16.9%) which is quite a high number, the common value in the industry is about 0.2-0.3%. So a high value is probably because non-clicks and clicks are subsampled according to different strategies, as stated by Avazu.</p>

<p>Now, the question is which features should we use to create a predictive model? This is a difficult question that requires a deep knowledge of the problem domain. Let’s try to learn it from the dataset we have.</p>

<p>For example, let’s explore the <code>device_conn_type</code> feature. Our assumption might be that this is a categorical variable like Wi-Fi, 2G, 3G or LTE. This might be a relevant feature since clicking on an ad with a slow connection is not something common.</p>

<p>At first, we register the dataframe as a SQL table:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="n">df</span><span class="o">.</span><span class="n">registerTempTable</span><span class="o">(</span><span class="s">&quot;training&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and run the SQL query:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="o">%</span><span class="k">sql</span>
</span><span class="line"><span class="k">SELECT</span> <span class="n">device_conn_type</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">click</span><span class="p">)</span> <span class="k">as</span> <span class="n">clicks_num</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">click</span><span class="p">)</span> <span class="k">as</span> <span class="n">impression</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">click</span><span class="p">)</span><span class="o">/</span><span class="k">COUNT</span><span class="p">(</span><span class="n">click</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctr</span>
</span><span class="line"><span class="k">FROM</span> <span class="n">training</span>
</span><span class="line"><span class="k">GROUP</span> <span class="k">BY</span> <span class="n">device_conn_type</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="/images/ie-ml/6_device_conn_type.png" /></p>

<p><img src="/images/ie-ml/7_device_conn_type_2.png" /></p>

<p>We see that there are four connection type categories. Two categories with CTR 18% and 13%, and the first one is almost 90% of the whole dataset. The other two categories have significantly lower CTR.</p>

<p>Another observation we may notice is that features C15 and C16 look like the ad size:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="o">%</span><span class="k">sql</span>
</span><span class="line"><span class="k">SELECT</span> <span class="n">C15</span><span class="p">,</span> <span class="n">C16</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">click</span><span class="p">)</span> <span class="k">as</span> <span class="n">impression</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">click</span><span class="p">)</span><span class="o">/</span><span class="k">COUNT</span><span class="p">(</span><span class="n">click</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctr</span>
</span><span class="line"><span class="k">FROM</span> <span class="n">training</span>
</span><span class="line"><span class="k">GROUP</span> <span class="k">BY</span> <span class="n">C15</span><span class="p">,</span> <span class="n">C16</span>
</span><span class="line"><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">ctr</span> <span class="k">DESC</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="/images/ie-ml/11_banner_dimension.png" /></p>

<p>We can notice some correlation between the ad size and its performance. The most common one appears to be 320x50px known as “mobile leaderboard” in <a href="https://support.google.com/adsense/answer/68727?hl=en">Google AdSense</a>.</p>

<p>What about other features? All of them represent categorical values, how many unique categories for each feature?</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">c</span><span class="o">).</span><span class="n">distinct</span><span class="o">().</span><span class="n">count</span><span class="o">()))</span>
</span><span class="line">
</span><span class="line"><span class="n">res14</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Long</span><span class="o">)]</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">((</span><span class="n">id</span><span class="o">,</span><span class="mi">40428967</span><span class="o">),</span> <span class="o">(</span><span class="n">click</span><span class="o">,</span><span class="mi">2</span><span class="o">),</span> <span class="o">(</span><span class="n">hour</span><span class="o">,</span><span class="mi">240</span><span class="o">),</span> <span class="o">(</span><span class="n">C1</span><span class="o">,</span><span class="mi">7</span><span class="o">),</span> <span class="o">(</span><span class="n">banner_pos</span><span class="o">,</span><span class="mi">7</span><span class="o">),</span> <span class="o">(</span><span class="n">site_id</span><span class="o">,</span><span class="mi">4737</span><span class="o">),</span> <span class="o">(</span><span class="n">site_domain</span><span class="o">,</span><span class="mi">7745</span><span class="o">),</span> <span class="o">(</span><span class="n">site_category</span><span class="o">,</span><span class="mi">26</span><span class="o">),</span> <span class="o">(</span><span class="n">app_id</span><span class="o">,</span><span class="mi">8552</span><span class="o">),</span> <span class="o">(</span><span class="n">app_domain</span><span class="o">,</span><span class="mi">559</span><span class="o">),</span> <span class="o">(</span><span class="n">app_category</span><span class="o">,</span><span class="mi">36</span><span class="o">),</span> <span class="o">(</span><span class="n">device_id</span><span class="o">,</span><span class="mi">2686408</span><span class="o">),</span> <span class="o">(</span><span class="n">device_ip</span><span class="o">,</span><span class="mi">6729486</span><span class="o">),</span> <span class="o">(</span><span class="n">device_model</span><span class="o">,</span><span class="mi">8251</span><span class="o">),</span> <span class="o">(</span><span class="n">device_type</span><span class="o">,</span><span class="mi">5</span><span class="o">),</span> <span class="o">(</span><span class="n">device_conn_type</span><span class="o">,</span><span class="mi">4</span><span class="o">),</span> <span class="o">(</span><span class="n">C14</span><span class="o">,</span><span class="mi">2626</span><span class="o">),</span> <span class="o">(</span><span class="n">C15</span><span class="o">,</span><span class="mi">8</span><span class="o">),</span> <span class="o">(</span><span class="n">C16</span><span class="o">,</span><span class="mi">9</span><span class="o">),</span> <span class="o">(</span><span class="n">C17</span><span class="o">,</span><span class="mi">435</span><span class="o">),</span> <span class="o">(</span><span class="n">C18</span><span class="o">,</span><span class="mi">4</span><span class="o">),</span> <span class="o">(</span><span class="n">C19</span><span class="o">,</span><span class="mi">68</span><span class="o">),</span> <span class="o">(</span><span class="n">C20</span><span class="o">,</span><span class="mi">172</span><span class="o">),</span> <span class="o">(</span><span class="n">C21</span><span class="o">,</span><span class="mi">60</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We see that there are some features with a lot of unique values, for example, <code>device_ip</code> has 6M+ different values.
Machine learning algorithms are typically defined in terms of numerical vectors rather than categorical values. Converting such categorical features will result in a high dimensional vector which might be very expensive.
We will need to deal with this later.</p>

<h2 id="processing-and-transforming-the-data">Processing and transforming the data</h2>

<p>Looking further at the dataset, we can see that the <code>hour</code> feature is in <code>YYMMDDHH</code> format.
To allow the predictive model to effectively learn from this feature it makes sense to transform it into three features: year, month and hour.
Let’s develop the function to transform the dataframe:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">import</span> <span class="nn">java.text.SimpleDateFormat</span>
</span><span class="line"><span class="k">import</span> <span class="nn">java.util.</span><span class="o">{</span><span class="nc">Calendar</span><span class="o">,</span> <span class="nc">Date</span><span class="o">}</span>
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.sql.DataFrame</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">DateUtils</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">dateFormat</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">[</span><span class="kt">SimpleDateFormat</span><span class="o">]()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">initialValue</span><span class="o">()</span><span class="k">:</span> <span class="kt">SimpleDateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyMMddHH&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">parse</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">field</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">date</span> <span class="k">=</span> <span class="n">dateFormat</span><span class="o">.</span><span class="n">get</span><span class="o">().</span><span class="n">parse</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">cal</span> <span class="k">=</span> <span class="nc">Calendar</span><span class="o">.</span><span class="n">getInstance</span><span class="o">()</span>
</span><span class="line">    <span class="n">cal</span><span class="o">.</span><span class="n">setTime</span><span class="o">(</span><span class="n">date</span><span class="o">)</span>
</span><span class="line">    <span class="n">cal</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">field</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">transformHour</span><span class="o">(</span><span class="n">df</span><span class="k">:</span> <span class="kt">DataFrame</span><span class="o">)</span><span class="k">:</span> <span class="kt">DataFrame</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">toYear</span> <span class="k">=</span> <span class="n">udf</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">](</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nc">Calendar</span><span class="o">.</span><span class="nc">YEAR</span><span class="o">))</span>
</span><span class="line">  <span class="k">val</span> <span class="n">toMonth</span> <span class="k">=</span> <span class="n">udf</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">](</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nc">Calendar</span><span class="o">.</span><span class="nc">MONTH</span><span class="o">))</span>
</span><span class="line">  <span class="k">val</span> <span class="n">toDay</span> <span class="k">=</span> <span class="n">udf</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">](</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nc">Calendar</span><span class="o">.</span><span class="nc">DAY_OF_MONTH</span><span class="o">))</span>
</span><span class="line">  <span class="k">val</span> <span class="n">toHour</span> <span class="k">=</span> <span class="n">udf</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">](</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nc">Calendar</span><span class="o">.</span><span class="nc">HOUR_OF_DAY</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;time_year&quot;</span><span class="o">,</span> <span class="n">toYear</span><span class="o">(</span><span class="n">df</span><span class="o">(</span><span class="s">&quot;hour&quot;</span><span class="o">)))</span>
</span><span class="line">  <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;time_month&quot;</span><span class="o">,</span> <span class="n">toMonth</span><span class="o">(</span><span class="n">df</span><span class="o">(</span><span class="s">&quot;hour&quot;</span><span class="o">)))</span>
</span><span class="line">  <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;time_day&quot;</span><span class="o">,</span> <span class="n">toDay</span><span class="o">(</span><span class="n">df</span><span class="o">(</span><span class="s">&quot;hour&quot;</span><span class="o">)))</span>
</span><span class="line">  <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;time_hour&quot;</span><span class="o">,</span> <span class="n">toHour</span><span class="o">(</span><span class="n">df</span><span class="o">(</span><span class="s">&quot;hour&quot;</span><span class="o">)))</span>
</span><span class="line">  <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;hour&quot;</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We can now apply this transformation to our dataframe and see the result:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">hourDecoded</span> <span class="k">=</span> <span class="n">transformHour</span><span class="o">(</span><span class="n">df</span><span class="o">)</span>
</span><span class="line"><span class="n">hourDecoded</span><span class="o">.</span><span class="n">cache</span><span class="o">()</span>
</span><span class="line"><span class="n">hourDecoded</span><span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="o">+--------------------+-----+----+----------+--------+-----------+-------------+--------+----------+------------+---------+---------+------------+-----------+----------------+-----+---+---+----+---+---+------+---+---------+----------+--------+---------+</span>
</span><span class="line"><span class="o">|</span>                  <span class="n">id</span><span class="o">|</span><span class="n">click</span><span class="o">|</span>  <span class="n">C1</span><span class="o">|</span><span class="n">banner_pos</span><span class="o">|</span> <span class="n">site_id</span><span class="o">|</span><span class="n">site_domain</span><span class="o">|</span><span class="n">site_category</span><span class="o">|</span>  <span class="n">app_id</span><span class="o">|</span><span class="n">app_domain</span><span class="o">|</span><span class="n">app_category</span><span class="o">|</span><span class="n">device_id</span><span class="o">|</span><span class="n">device_ip</span><span class="o">|</span><span class="n">device_model</span><span class="o">|</span><span class="n">device_type</span><span class="o">|</span><span class="n">device_conn_type</span><span class="o">|</span>  <span class="n">C14</span><span class="o">|</span><span class="n">C15</span><span class="o">|</span><span class="n">C16</span><span class="o">|</span> <span class="n">C17</span><span class="o">|</span><span class="n">C18</span><span class="o">|</span><span class="n">C19</span><span class="o">|</span>   <span class="n">C20</span><span class="o">|</span><span class="n">C21</span><span class="o">|</span><span class="n">time_year</span><span class="o">|</span><span class="n">time_month</span><span class="o">|</span><span class="n">time_day</span><span class="o">|</span><span class="n">time_hour</span><span class="o">|</span>
</span><span class="line"><span class="o">+--------------------+-----+----+----------+--------+-----------+-------------+--------+----------+------------+---------+---------+------------+-----------+----------------+-----+---+---+----+---+---+------+---+---------+----------+--------+---------+</span>
</span><span class="line"><span class="o">|</span> <span class="mi">1000009418151094273</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">ddd2926e</span><span class="o">|</span>    <span class="mi">44956</span><span class="n">a24</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">2</span><span class="o">|</span><span class="mi">15706</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000169349117863715</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="mi">96809</span><span class="n">ac8</span><span class="o">|</span>    <span class="mi">711</span><span class="n">ee120</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">15704</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span><span class="mi">100084</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000371904215119486</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">b3cf8def</span><span class="o">|</span>    <span class="mi">8</span><span class="n">a4875bd</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">15704</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span><span class="mi">100084</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000640724480838376</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">e8275b8f</span><span class="o">|</span>    <span class="mi">6332421</span><span class="n">a</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">15706</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span><span class="mi">100084</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000679056417042096</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">1</span><span class="o">|</span><span class="n">fe8cc448</span><span class="o">|</span>   <span class="mi">9166</span><span class="n">c161</span><span class="o">|</span>     <span class="mi">0569</span><span class="n">f928</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="mi">9644</span><span class="n">d0bf</span><span class="o">|</span>    <span class="mi">779</span><span class="n">d90c2</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">18993</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">2161</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span><span class="mi">157</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000720757801103869</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="n">d6137915</span><span class="o">|</span>   <span class="n">bb1ef334</span><span class="o">|</span>     <span class="n">f028772b</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="mi">05241</span><span class="n">af0</span><span class="o">|</span>    <span class="mi">8</span><span class="n">a4875bd</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">16920</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1899</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span><span class="mi">431</span><span class="o">|</span><span class="mi">100077</span><span class="o">|</span><span class="mi">117</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000724729988544911</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">8</span><span class="n">fda644b</span><span class="o">|</span>   <span class="mi">25</span><span class="n">d4cfcd</span><span class="o">|</span>     <span class="n">f028772b</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">b264c159</span><span class="o">|</span>    <span class="n">be6db1d7</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">20362</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">2333</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">39</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span><span class="mi">157</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000918755742328737</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">1</span><span class="o">|</span><span class="n">e151e245</span><span class="o">|</span>   <span class="mi">7</span><span class="n">e091613</span><span class="o">|</span>     <span class="n">f028772b</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="n">e6f67278</span><span class="o">|</span>    <span class="n">be74e6fe</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">20632</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">2374</span><span class="o">|</span>  <span class="mi">3</span><span class="o">|</span> <span class="mi">39</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span> <span class="mi">23</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10000949271186029916</span><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span><span class="mi">1005</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="n">fbe01fe</span><span class="o">|</span>   <span class="n">f3845767</span><span class="o">|</span>     <span class="mi">28905</span><span class="n">ebd</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">a99f214a</span><span class="o">|</span> <span class="mi">37</span><span class="n">e8da74</span><span class="o">|</span>    <span class="mi">5</span><span class="n">db079b5</span><span class="o">|</span>          <span class="mi">1</span><span class="o">|</span>               <span class="mi">2</span><span class="o">|</span><span class="mi">15707</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">1722</span><span class="o">|</span>  <span class="mi">0</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span>    <span class="o">-</span><span class="mi">1</span><span class="o">|</span> <span class="mi">79</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">|</span><span class="mi">10001264480619467364</span><span class="o">|</span>    <span class="mi">0</span><span class="o">|</span><span class="mi">1002</span><span class="o">|</span>         <span class="mi">0</span><span class="o">|</span><span class="mi">84</span><span class="n">c7ba46</span><span class="o">|</span>   <span class="n">c4e18dd6</span><span class="o">|</span>     <span class="mi">50</span><span class="n">e219e0</span><span class="o">|</span><span class="n">ecad2386</span><span class="o">|</span>  <span class="mi">7801</span><span class="n">e8d9</span><span class="o">|</span>    <span class="mi">07</span><span class="n">d7df22</span><span class="o">|</span> <span class="n">c357dbff</span><span class="o">|</span> <span class="n">f1ac7184</span><span class="o">|</span>    <span class="mi">373</span><span class="n">ecbe6</span><span class="o">|</span>          <span class="mi">0</span><span class="o">|</span>               <span class="mi">0</span><span class="o">|</span><span class="mi">21689</span><span class="o">|</span><span class="mi">320</span><span class="o">|</span> <span class="mi">50</span><span class="o">|</span><span class="mi">2496</span><span class="o">|</span>  <span class="mi">3</span><span class="o">|</span><span class="mi">167</span><span class="o">|</span><span class="mi">100191</span><span class="o">|</span> <span class="mi">23</span><span class="o">|</span>     <span class="mi">2014</span><span class="o">|</span>         <span class="mi">9</span><span class="o">|</span>      <span class="mi">21</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
</span><span class="line"><span class="o">+--------------------+-----+----+----------+--------+-----------+-------------+--------+----------+------------+---------+---------+------------+-----------+----------------+-----+---+---+----+---+---+------+---+---------+----------+--------+---------+</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It looks like the year and month have only one value, let’s verify it:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="n">hourDecoded</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;time_month&quot;</span><span class="o">).</span><span class="n">distinct</span><span class="o">.</span><span class="n">count</span><span class="o">()</span>
</span><span class="line"><span class="n">hourDecoded</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;time_year&quot;</span><span class="o">).</span><span class="n">distinct</span><span class="o">.</span><span class="n">count</span><span class="o">()</span>
</span><span class="line">
</span><span class="line"><span class="n">res20</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="line"><span class="n">res21</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We can safely drop these columns as they don’t bring any knowledge to our model:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">hourDecoded2</span> <span class="k">=</span> <span class="n">hourDecoded</span><span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;time_month&quot;</span><span class="o">).</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;time_year&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Let’s also convert <code>click</code> from String to Double type.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.sql.types.DoubleType</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">prepared</span> <span class="k">=</span> <span class="n">hourDecoded2</span>
</span><span class="line">    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;clickTmp&quot;</span><span class="o">,</span> <span class="n">hourDecoded2</span><span class="o">(</span><span class="s">&quot;click&quot;</span><span class="o">).</span><span class="n">cast</span><span class="o">(</span><span class="nc">DoubleType</span><span class="o">))</span>
</span><span class="line">    <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;click&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="o">(</span><span class="s">&quot;clickTmp&quot;</span><span class="o">,</span> <span class="s">&quot;click&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="saving-preprocessed-data-to-the-data-grid">Saving preprocessed data to the data grid</h2>

<p>The entire training dataset contains 40M+ rows, it takes quite a long time to experiment with different algorithms and approaches even in a clustered environment.
We want to sample the dataset and checkpoint it to the in-memory data grid that is running collocated with Spark.
This way we can:
* quickly iterate through different approaches
* restart the Zeppelin session or launch other Spark applications and pick up the dataset more quickly from memory</p>

<p>Since the training dataset contains the data for the 10 days, we can pick any day and sample it:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="n">prepared</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">&quot;time_day = 21&quot;</span><span class="o">).</span><span class="n">count</span><span class="o">()</span>
</span><span class="line">
</span><span class="line"><span class="n">res51</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">4122995</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>There are 4M+ rows for this day, which is about 10% of the entire dataset.</p>

<p>Now let’s save it to the data grid. This can be done with two lines of code:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.sql.insightedge._</span>
</span><span class="line"><span class="n">prepared</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">&quot;time_day = 21&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">save</span><span class="o">(</span><span class="s">&quot;day_21&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Any time later in another Spark context we can bring the collection to the Spark memory with:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;day_21&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Also, we want to transform the <code>test</code> dataset that we will use for prediction in a similar way.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">testDf</span> <span class="k">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span>
</span><span class="line">      <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;com.databricks.spark.csv&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;header&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;inferSchema&quot;</span><span class="o">,</span> <span class="s">&quot;false&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;hdfs://10.8.1.116/data/avazu_ctr/test&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="n">transformHour</span><span class="o">(</span><span class="n">testDf</span><span class="o">)</span>
</span><span class="line">    <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;time_month&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;time_year&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">save</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The complete listing of notebook can be found on <a href="https://github.com/InsightEdge/insightedge-ctr-demo/blob/master/zeppelin/CTR%20demo.json">github</a>. You can import it to Zeppelin and play with it on your own.</p>

<h2 id="a-simple-algorithm">A simple algorithm</h2>

<p>Now that we have training and test datasets sampled, initially preprocessed and available in the data grid, we can close Web Notebook and start experimenting with
different techniques and algorithms by submitting Spark applications.</p>

<p>For our first baseline approach let’s take a single feature <code>device_conn_type</code> and <a href="https://en.wikipedia.org/wiki/Logistic_regression">logistic regression</a> algorithm:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">import</span> <span class="nn">com.gigaspaces.spark.context.GigaSpacesConfig</span>
</span><span class="line"><span class="k">import</span> <span class="nn">com.gigaspaces.spark.implicits._</span>
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.ml.feature.</span><span class="o">{</span><span class="nc">OneHotEncoder</span><span class="o">,</span> <span class="nc">StringIndexer</span><span class="o">}</span>
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.mllib.classification.LogisticRegressionWithLBFGS</span>
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.mllib.evaluation.BinaryClassificationMetrics</span>
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.mllib.linalg.Vector</span>
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.mllib.regression.LabeledPoint</span>
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.sql.SQLContext</span>
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.sql.insightedge._</span>
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.spark.</span><span class="o">{</span><span class="nc">SparkConf</span><span class="o">,</span> <span class="nc">SparkContext</span><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">CtrDemo1</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">System</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Usage: CtrDemo1 &lt;spark master url&gt; &lt;grid locator&gt; &lt;train collection&gt;&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="nc">System</span><span class="o">.</span><span class="n">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="nc">Array</span><span class="o">(</span><span class="n">master</span><span class="o">,</span> <span class="n">gridLocator</span><span class="o">,</span> <span class="n">trainCollection</span><span class="o">)</span> <span class="k">=</span> <span class="n">args</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Configure InsightEdge settings</span>
</span><span class="line">    <span class="k">val</span> <span class="n">gsConfig</span> <span class="k">=</span> <span class="nc">GigaSpacesConfig</span><span class="o">(</span><span class="s">&quot;insightedge-space&quot;</span><span class="o">,</span> <span class="nc">None</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="n">gridLocator</span><span class="o">))</span>
</span><span class="line">    <span class="k">val</span> <span class="n">sc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkContext</span><span class="o">(</span><span class="k">new</span> <span class="nc">SparkConf</span><span class="o">().</span><span class="n">setAppName</span><span class="o">(</span><span class="s">&quot;CtrDemo1&quot;</span><span class="o">).</span><span class="n">setMaster</span><span class="o">(</span><span class="n">master</span><span class="o">).</span><span class="n">setGigaSpaceConfig</span><span class="o">(</span><span class="n">gsConfig</span><span class="o">))</span>
</span><span class="line">    <span class="k">val</span> <span class="n">sqlContext</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SQLContext</span><span class="o">(</span><span class="n">sc</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// load training collection from data grid</span>
</span><span class="line">    <span class="k">val</span> <span class="n">trainDf</span> <span class="k">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="n">trainCollection</span><span class="o">)</span>
</span><span class="line">    <span class="n">trainDf</span><span class="o">.</span><span class="n">cache</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// use one-hot-encoder to convert &#39;device_conn_type&#39; categorical feature into a vector</span>
</span><span class="line">    <span class="k">val</span> <span class="n">indexed</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringIndexer</span><span class="o">()</span>
</span><span class="line">      <span class="o">.</span><span class="n">setInputCol</span><span class="o">(</span><span class="s">&quot;device_conn_type&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">setOutputCol</span><span class="o">(</span><span class="s">&quot;device_conn_type_index&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">fit</span><span class="o">(</span><span class="n">trainDf</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">trainDf</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">encodedDf</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">OneHotEncoder</span><span class="o">()</span>
</span><span class="line">      <span class="o">.</span><span class="n">setDropLast</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">setInputCol</span><span class="o">(</span><span class="s">&quot;device_conn_type_index&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">setOutputCol</span><span class="o">(</span><span class="s">&quot;device_conn_type_vector&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">indexed</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// convert dataframe to a label points RDD</span>
</span><span class="line">    <span class="k">val</span> <span class="n">encodedRdd</span> <span class="k">=</span> <span class="n">encodedDf</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">row</span> <span class="k">=&gt;</span>
</span><span class="line">      <span class="k">val</span> <span class="n">label</span> <span class="k">=</span> <span class="n">row</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">Double</span><span class="o">](</span><span class="s">&quot;click&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="k">val</span> <span class="n">features</span> <span class="k">=</span> <span class="n">row</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">Vector</span><span class="o">](</span><span class="s">&quot;device_conn_type_vector&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="nc">LabeledPoint</span><span class="o">(</span><span class="n">label</span><span class="o">,</span> <span class="n">features</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Split data into training (60%) and test (40%)</span>
</span><span class="line">    <span class="k">val</span> <span class="nc">Array</span><span class="o">(</span><span class="n">trainingRdd</span><span class="o">,</span> <span class="n">testRdd</span><span class="o">)</span> <span class="k">=</span> <span class="n">encodedRdd</span><span class="o">.</span><span class="n">randomSplit</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="mf">0.6</span><span class="o">,</span> <span class="mf">0.4</span><span class="o">),</span> <span class="n">seed</span> <span class="k">=</span> <span class="mi">11L</span><span class="o">)</span>
</span><span class="line">    <span class="n">trainingRdd</span><span class="o">.</span><span class="n">cache</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Run training algorithm to build the model</span>
</span><span class="line">    <span class="k">val</span> <span class="n">model</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LogisticRegressionWithLBFGS</span><span class="o">()</span>
</span><span class="line">      <span class="o">.</span><span class="n">setNumClasses</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">trainingRdd</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Clear the prediction threshold so the model will return probabilities</span>
</span><span class="line">    <span class="n">model</span><span class="o">.</span><span class="n">clearThreshold</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Compute raw scores on the test set</span>
</span><span class="line">    <span class="k">val</span> <span class="n">predictionAndLabels</span> <span class="k">=</span> <span class="n">testRdd</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="k">case</span> <span class="nc">LabeledPoint</span><span class="o">(</span><span class="n">label</span><span class="o">,</span> <span class="n">features</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class="line">      <span class="k">val</span> <span class="n">prediction</span> <span class="k">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="o">(</span><span class="n">features</span><span class="o">)</span>
</span><span class="line">      <span class="o">(</span><span class="n">prediction</span><span class="o">,</span> <span class="n">label</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Instantiate metrics object</span>
</span><span class="line">    <span class="k">val</span> <span class="n">metrics</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">BinaryClassificationMetrics</span><span class="o">(</span><span class="n">predictionAndLabels</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">auROC</span> <span class="k">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">areaUnderROC</span>
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;Area under ROC = &quot;</span> <span class="o">+</span> <span class="n">auROC</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We will explain a little bit more what happens here.</p>

<p>At first, we load the training dataset from the data grid, which we prepared and saved earlier with Web Notebook.</p>

<p>Then we use <a href="https://spark.apache.org/docs/1.6.0/api/java/org/apache/spark/ml/feature/StringIndexer.html">StringIndexer</a> and <a href="https://spark.apache.org/docs/1.6.0/api/java/org/apache/spark/ml/feature/OneHotEncoder.html">OneHotEncoder</a> to map  a column of categories to a column of binary vectors. For example, with 4 categories of <code>device_conn_type</code>, an input value
of the second category would map to an output vector of <code>[0.0, 1.0, 0.0, 0.0, 0.0]</code>.</p>

<p>Then we convert a dataframe to an <code>RDD[LabeledPoint]</code> since the <a href="https://spark.apache.org/docs/1.6.0/api/java/org/apache/spark/mllib/classification/LogisticRegressionWithLBFGS.html">LogisticRegressionWithLBFGS</a> expects RDD as a training parameter.
We train the logistic regression and use it to predict the click for the test dataset. Finally we compute the metrics of our classifier comparing the predicted labels with actual ones.</p>

<p>To build this application and submit it to the InsightEdge cluster:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">sbt clean assembly
</span><span class="line">./bin/insightedge-submit --class io.insightedge.demo.ctr.CtrDemo1 --master spark://10.8.1.115:7077 --executor-memory 16G  ~/avazu_ctr/insightedge-ctr-demo-assembly-1.0.0.jar spark://10.8.1.115:7077 10.8.1.115:4174 day_21
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It takes about 2 minutes for the application to complete and output the following:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">Area under <span class="nv">ROC</span> <span class="o">=</span> 0.5177127622153417
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We get <a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic#Area_under_the_curve">AUROC</a> slightly better than a random guess (AUROC = 0.5), which is not so bad for our first approach, but we can definitely do better.</p>

<h2 id="experimenting-with-more-features">Experimenting with more features</h2>

<p>Let’s try to select more features and see how it affects our metrics.</p>

<p>For this we created a new version of our app <a href="https://github.com/InsightEdge/insightedge-ctr-demo/blob/master/src/main/scala/io/insightedge/demo/ctr/CtrDemo2.scala">CtrDemo2</a> where we
can easily select features we want to include. We use <a href="https://spark.apache.org/docs/1.6.0/api/java/org/apache/spark/ml/feature/VectorAssembler.html">VectorAssembler</a> to assemble multiple feature vectors into a single <code>features</code> one:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">assembledDf</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">VectorAssembler</span><span class="o">()</span>
</span><span class="line">  <span class="o">.</span><span class="n">setInputCols</span><span class="o">(</span><span class="n">categoricalColumnsVectors</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span>
</span><span class="line">  <span class="o">.</span><span class="n">setOutputCol</span><span class="o">(</span><span class="s">&quot;features&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">encodedDf</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The results are the following:</p>

<ul>
  <li>with additionally included <code>device_type</code>: AUROC = 0.531015564807053</li>
  <li><code>+</code> <code>time_day</code> and <code>time_hour</code>: AUROC = 0.5555488992624483</li>
  <li><code>+</code> <code>C15</code>, <code>C16</code>, <code>C17</code>, <code>C18</code>, <code>C19</code>, <code>C20</code>, <code>C21</code>: AUROC = 0.7000630113145946</li>
</ul>

<p>You can notice how the AUROC is being improved as we add more and more features. This comes with the cost of the training time:</p>

<p><img src="/images/ie-ml/13_application_time.png" /></p>

<p>We didn’t include high-cardinality features such as <code>device_ip</code> and <code>device_id</code> as they will blow up the feature vector size. One may consider applying techniques such as feature hashing
to reduce the dimension. We will leave it out of this blog post’s scope.</p>

<h2 id="tuning-algorithm-parameters">Tuning algorithm parameters</h2>

<p>Tuning algorithm parameters is a search problem. We will use <a href="http://spark.apache.org/docs/latest/ml-guide.html">Spark Pipeline API</a> with a <a href="https://en.wikipedia.org/wiki/Hyperparameter_optimization">Grid Search</a> technique.
Grid search evaluates a model for each combination of algorithm parameters specified in a grid (do not confuse with data grid).</p>

<p>Pipeline API supports model selection using <a href="https://en.wikipedia.org/wiki/Cross-validation_(statistics)">cross-validation</a> technique. For each set of parameters it trains the given <code>Estimator</code> and evaluates it using the given <code>Evaluator</code>.
We will use <code>BinaryClassificationEvaluator</code> that has AUROC as a metric by default.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">lr</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LogisticRegression</span><span class="o">().</span><span class="n">setLabelCol</span><span class="o">(</span><span class="s">&quot;click&quot;</span><span class="o">)</span>
</span><span class="line"><span class="k">val</span> <span class="n">pipeline</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Pipeline</span><span class="o">().</span><span class="n">setStages</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="n">assembler</span><span class="o">,</span> <span class="n">lr</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">paramGrid</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ParamGridBuilder</span><span class="o">()</span>
</span><span class="line">  <span class="o">.</span><span class="n">addGrid</span><span class="o">(</span><span class="n">lr</span><span class="o">.</span><span class="n">regParam</span><span class="o">,</span> <span class="nc">Array</span><span class="o">(</span><span class="mf">0.01</span> <span class="o">,</span> <span class="mf">0.1</span> <span class="cm">/*, 1.0 */</span><span class="o">))</span>
</span><span class="line">  <span class="o">.</span><span class="n">addGrid</span><span class="o">(</span><span class="n">lr</span><span class="o">.</span><span class="n">elasticNetParam</span><span class="o">,</span> <span class="nc">Array</span><span class="o">(</span><span class="mf">0.0</span> <span class="cm">/*, 0.5 , 1.0 */</span><span class="o">))</span>
</span><span class="line">  <span class="o">.</span><span class="n">addGrid</span><span class="o">(</span><span class="n">lr</span><span class="o">.</span><span class="n">fitIntercept</span><span class="o">,</span> <span class="nc">Array</span><span class="o">(</span><span class="kc">false</span> <span class="cm">/*, true */</span><span class="o">))</span>
</span><span class="line">  <span class="o">.</span><span class="n">build</span><span class="o">()</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">cv</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CrossValidator</span><span class="o">()</span>
</span><span class="line">  <span class="o">.</span><span class="n">setEstimator</span><span class="o">(</span><span class="n">pipeline</span><span class="o">)</span>
</span><span class="line">  <span class="o">.</span><span class="n">setEvaluator</span><span class="o">(</span><span class="k">new</span> <span class="nc">BinaryClassificationEvaluator</span><span class="o">().</span><span class="n">setLabelCol</span><span class="o">(</span><span class="s">&quot;click&quot;</span><span class="o">))</span>
</span><span class="line">  <span class="o">.</span><span class="n">setEstimatorParamMaps</span><span class="o">(</span><span class="n">paramGrid</span><span class="o">)</span>
</span><span class="line">  <span class="o">.</span><span class="n">setNumFolds</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">cvModel</span> <span class="k">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fit</span><span class="o">(</span><span class="n">encodedTrainDf</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We included two regularization parameters 0.01 and 0.1 in our search grid for now, others are commented out for now.</p>

<p>Output the best set of parameters:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="n">println</span><span class="o">(</span><span class="s">&quot;Grid search results:&quot;</span><span class="o">)</span>
</span><span class="line"><span class="n">cvModel</span><span class="o">.</span><span class="n">getEstimatorParamMaps</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">cvModel</span><span class="o">.</span><span class="n">avgMetrics</span><span class="o">).</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="n">println</span><span class="o">(</span><span class="s">&quot;Best set of parameters found:&quot;</span> <span class="o">+</span> <span class="n">cvModel</span><span class="o">.</span><span class="n">getEstimatorParamMaps</span>
</span><span class="line">  <span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">cvModel</span><span class="o">.</span><span class="n">avgMetrics</span><span class="o">)</span>
</span><span class="line">  <span class="o">.</span><span class="n">maxBy</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
</span><span class="line">  <span class="o">.</span><span class="n">_1</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Use the best model to predict <code>test</code> dataset loaded from the data grid:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">predictionDf</span> <span class="k">=</span> <span class="n">cvModel</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">encodedTestDf</span><span class="o">).</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;probability&quot;</span><span class="o">).</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="nc">Row</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">probability</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">probability</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span><span class="line"><span class="o">}.</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;click&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then the results are saved back to csv on hdfs, so we can submit them to Kaggle, see the complete listing in <a href="https://github.com/InsightEdge/insightedge-ctr-demo/blob/master/src/main/scala/io/insightedge/demo/ctr/CtrDemo3.scala">CtrDemo3</a>.</p>

<p>It takes about 27 mins to train and compare models for two regularization parameters 0.01 and 0.1. The results are:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="nc">Grid</span> <span class="n">search</span> <span class="n">results</span><span class="k">:</span>
</span><span class="line"><span class="o">({</span>
</span><span class="line">	<span class="kt">logreg_2b70e3edf1f0-elasticNetParam:</span> <span class="err">0</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span>
</span><span class="line">	<span class="kt">logreg_2b70e3edf1f0-fitIntercept:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class="line">	<span class="kt">logreg_2b70e3edf1f0-regParam:</span> <span class="err">0</span><span class="kt">.</span><span class="err">01</span>
</span><span class="line"><span class="o">},</span><span class="mf">0.7000655195682837</span><span class="o">)</span>
</span><span class="line"><span class="o">({</span>
</span><span class="line">	<span class="n">logreg_2b70e3edf1f0</span><span class="o">-</span><span class="n">elasticNetParam</span><span class="k">:</span> <span class="err">0</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span>
</span><span class="line">	<span class="n">logreg_2b70e3edf1f0</span><span class="o">-</span><span class="n">fitIntercept</span><span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class="line">	<span class="n">logreg_2b70e3edf1f0</span><span class="o">-</span><span class="n">regParam</span><span class="k">:</span> <span class="err">0</span><span class="kt">.</span><span class="err">1</span>
</span><span class="line"><span class="o">},</span><span class="mf">0.697680175815199</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="nc">Best</span> <span class="n">params</span> <span class="n">found</span><span class="k">:</span><span class="o">{</span>
</span><span class="line">	<span class="kt">logreg_2b70e3edf1f0-elasticNetParam:</span> <span class="err">0</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span>
</span><span class="line">	<span class="kt">logreg_2b70e3edf1f0-fitIntercept:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class="line">	<span class="n">logreg_2b70e3edf1f0</span><span class="o">-</span><span class="n">regParam</span><span class="k">:</span> <span class="err">0</span><span class="kt">.</span><span class="err">01</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This simple logistic regression model has a rank of 1109 out of 1603 competitors in Kaggle.</p>

<p>The future improvements are only limited by data science skills and creativity. One may consider:</p>

<ul>
  <li>implement <a href="https://www.kaggle.com/wiki/LogarithmicLoss">Logarithmic Loss</a> function as an Evaluator since it’s used by Kaggle to calculate the model score. In our example we used AUROC</li>
  <li>include other features that we didn’t select</li>
  <li>generate additional features such click history of a user</li>
  <li>use a hashing trick to reduce the features vector dimension</li>
  <li>try other machine learning algorithms, the winner of competition used  <a href="http://www.csie.ntu.edu.tw/~r01922136/slides/ffm.pdf">Field-aware Factorization Machines</a></li>
</ul>

<h2 id="architecture">Architecture</h2>

<p>The following diagram demonstrates the design of machine learning application with InsightEdge.</p>

<p><img src="/images/ie-ml/arch.png" /></p>

<p>The key design advantages are:</p>

<ul>
  <li>the single platform <strong>converges</strong> analytical processing (machine learning) powered by Spark with transactional processing powered by custom real-time applications;</li>
  <li>real-time applications can execute any OLTP query (read, insert, update, delete) on training data that is <strong>immediately available</strong> for Spark analytical queries or machine learning routines. There is no need to build a complex ETL pipeline that extracts training data from OLTP database with Kafka/Flume/HDFS. Besides the complexity, an ETL pipeline introduces unwanted latency that can be a stopper for reactive machine learning apps.
With InsightEdge, Spark applications can view the <strong>live</strong> data;</li>
  <li>the training data lives in the memory of data grid, which acts as an extension of Spark memory. This way we can load the data <strong>quicker</strong>;</li>
  <li>An in-memory data grid is a <strong>general-purpose</strong> highly available and fault tolerant storage. With support of ACID transactions and SQL queries it becomes the primary storage for the application;</li>
  <li>InsightEdge stack is <strong>scalable</strong> in both computation (Spark) and storage (data grid) tiers. This makes it attractive for large-scale machine learning.</li>
</ul>

<h2 id="summary">Summary</h2>

<p>In this blog post we demonstrated how to use machine learning algorithms with InsightEdge. We went through typical stages:</p>

<ul>
  <li>interactive data exploration with Zeppelin</li>
  <li>feature selection and transformation</li>
  <li>training predictive models</li>
  <li>calculating model metrics</li>
  <li>tuning parameters</li>
</ul>

<p>We didn’t have a goal to build a perfect predictive model, so there is great room for improvement.</p>

<p>In the architecture section we discussed how the typical design may look like, what are the benefits of using InsightEdge for machine learning.</p>

<p>The Zeppelin notebook can be found <a href="https://github.com/InsightEdge/insightedge-ctr-demo/blob/master/zeppelin/CTR%20demo.json">here</a> and submittable spark apps <a href="https://github.com/InsightEdge/insightedge-ctr-demo/tree/master/src/main/scala/io/insightedge/demo/ctr">here</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Oleksiy Dyagilev</span></span>

      




<time class='entry-date' datetime='2016-05-30T20:34:42+03:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:34 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/insightedge/'>insightedge,</a>, <a class='category' href='/blog/categories/learning/'>learning</a>, <a class='category' href='/blog/categories/machine/'>machine</a>, <a class='category' href='/blog/categories/spark/'>spark,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://dyagilev.org/blog/2016/05/30/scalable-machine-learning-with-insightedge-mobile-advertisement-clicks-prediction/" data-via="" data-counturl="http://dyagilev.org/blog/2016/05/30/scalable-machine-learning-with-insightedge-mobile-advertisement-clicks-prediction/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/01/20/java-enums-in-distributed-systems/" title="Previous Post: Java enums in distributed systems">&laquo; Java enums in distributed systems</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/09/29/real-time-spatial-analytics-with-insightedge-spark-taxi-price-surge-use-case/" title="Next Post: Real-time Spatial Analytics with InsightEdge Spark: Taxi Price Surge Use Case">Real-time Spatial Analytics with InsightEdge Spark: Taxi Price Surge Use Case &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/12/06/how-we-built-insightedge/">How we built InsightEdge. Slides and talk recording</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/09/29/real-time-spatial-analytics-with-insightedge-spark-taxi-price-surge-use-case/">Real-time Spatial Analytics with InsightEdge Spark: Taxi Price Surge Use Case</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/30/scalable-machine-learning-with-insightedge-mobile-advertisement-clicks-prediction/">Scalable machine learning with InsightEdge: mobile advertisement clicks prediction</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/20/java-enums-in-distributed-systems/">Java enums in distributed systems</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/03/slides-for-my-javaday-2015-talk/">Slides for my JavaDay 2015 talk</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Oleksiy Dyagilev -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dyagilev';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://dyagilev.org/blog/2016/05/30/scalable-machine-learning-with-insightedge-mobile-advertisement-clicks-prediction/';
        var disqus_url = 'http://dyagilev.org/blog/2016/05/30/scalable-machine-learning-with-insightedge-mobile-advertisement-clicks-prediction/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
